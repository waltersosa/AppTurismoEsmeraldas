<div *ngIf="loading" class="flex justify-center items-center p-8">
  <div class="text-[#6b8075] text-center">
    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#ceeddd] mx-auto mb-2"></div>
    <p>Cargando lugar...</p>
  </div>
</div>
<div *ngIf="error && !loading" class="flex justify-center items-center p-8">
  <div class="text-center">
    <p class="text-[#6b8075] mb-2">No se pudo cargar el lugar</p>
    <p class="text-sm text-[#6b8075]">Intenta nuevamente</p>
  </div>
</div>
<div *ngIf="!loading && place" class="relative flex size-full min-h-screen flex-col bg-white justify-between group/design-root overflow-x-hidden" style='font-family: "Plus Jakarta Sans", "Noto Sans", sans-serif;'>
  <div>
    <div class="flex items-center bg-white p-4 pb-2 justify-between">
      <button class="text-[#131614] flex size-12 shrink-0 items-center" routerLink="/places">
        <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
          <path d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z"></path>
        </svg>
      </button>
      <div class="flex w-12 items-center justify-end">
        <button class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 bg-transparent text-[#131614] gap-2 text-base font-bold leading-normal tracking-[0.015em] min-w-0 p-0">
          <div class="text-[#131614]">
            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
              <path d="M178,32c-20.65,0-38.73,8.88-50,23.89C116.73,40.88,98.65,32,78,32A62.07,62.07,0,0,0,16,94c0,70,103.79,126.66,108.21,129a8,8,0,0,0,7.58,0C136.21,220.66,240,164,240,94A62.07,62.07,0,0,0,178,32ZM128,206.8C109.74,196.16,32,147.69,32,94A46.06,46.06,0,0,1,78,48c19.45,0,35.78,10.36,42.6,27a8,8,0,0,0,14.8,0c6.82-16.67,23.15-27,42.6-27a46.06,46.06,0,0,1,46,46C224,147.61,146.24,196.15,128,206.8Z"/>
            </svg>
          </div>
        </button>
      </div>
    </div>
    <div class="@container">
      <div class="@[480px]:px-4 @[480px]:py-3">
        <div
          class="w-full bg-center bg-no-repeat bg-cover flex flex-col justify-end overflow-hidden bg-white @[480px]:rounded-xl min-h-80"
          [style.background-image]="'url(' + (place.coverImage || place.images[0] || '') + ')'"
        ></div>
      </div>
    </div>
    <h1 class="text-[#131614] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 text-left pb-3 pt-5">{{ place.name }}</h1>
    <p class="text-[#131614] text-base font-normal leading-normal pb-3 pt-1 px-4">{{ place.description }}</p>
    <h2 class="text-[#131614] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Ubicación</h2>
    <div class="flex px-4 py-3">
      <div
        class="w-full bg-center bg-no-repeat aspect-video bg-cover rounded-xl object-cover"
        [style.background-image]="'url(' + (place.images[0] || place.coverImage || '') + ')'"
      ></div>
    </div>
    <div class="flex px-4 py-3 justify-end">
      <button
        class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-[#ceeddd] text-[#131614] text-sm font-bold leading-normal tracking-[0.015em]"
      >
        <span class="truncate">Cómo llegar</span>
      </button>
    </div>
    <h2 class="text-[#131614] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Comentarios y valoraciones</h2>
    <div class="flex flex-wrap gap-x-8 gap-y-6 p-4">
      <div class="flex flex-col gap-2">
        <p class="text-[#131614] text-4xl font-black leading-tight tracking-[-0.033em]">{{ averageRating | number:'1.1-2' }}</p>
        <div class="flex gap-0.5">
          <ng-container *ngFor="let star of [1,2,3,4,5]">
            <div class="text-[#131614]" *ngIf="averageRating >= star">
              <svg xmlns="http://www.w3.org/2000/svg" width="18px" height="18px" fill="currentColor" viewBox="0 0 256 256">
                <path d="M234.5,114.38l-45.1,39.36,13.51,58.6a16,16,0,0,1-23.84,17.34l-51.11-31-51,31a16,16,0,0,1-23.84-17.34L66.61,153.8,21.5,114.38a16,16,0,0,1,9.11-28.06l59.46-5.15,23.21-55.36a15.95,15.95,0,0,1,29.44,0h0L166,81.17l59.44,5.15a16,16,0,0,1,9.11,28.06Z"/>
              </svg>
            </div>
            <div class="text-[#bfcac4]" *ngIf="averageRating < star">
              <svg xmlns="http://www.w3.org/2000/svg" width="18px" height="18px" fill="currentColor" viewBox="0 0 256 256">
                <path d="M239.2,97.29a16,16,0,0,0-13.81-11L166,81.17,142.72,25.81h0a15.95,15.95,0,0,0-29.44,0L90.07,81.17,30.61,86.32a16,16,0,0,0-9.11,28.06L66.61,153.8,53.09,212.34a16,16,0,0,0,23.84,17.34l51-31,51.11,31a16,16,0,0,0,23.84-17.34l-13.51-58.6,45.1-39.36A16,16,0,0,0,239.2,97.29Zm-15.22,5-45.1,39.36a16,16,0,0,0-5.08,15.71L187.35,216v0l-51.07-31a15.9,15.9,0,0,0-16.54,0l-51,31h0L82.2,157.4a16,16,0,0,0-5.08-15.71L32,102.35a.37.37,0,0,1,0-.09l59.44-5.14a16,16,0,0,0,13.35-9.75L128,32.08l23.2,55.29a16,16,0,0,0,13.35,9.75L224,102.26S224,102.32,224,102.33Z"/>
              </svg>
            </div>
          </ng-container>
        </div>
        <p class="text-[#131614] text-base font-normal leading-normal">{{ reviews.length }} reseñas</p>
      </div>
      <div class="grid min-w-[200px] max-w-[400px] flex-1 grid-cols-[20px_1fr_40px] items-center gap-y-3">
        <ng-container *ngFor="let star of [5,4,3,2,1]">
          <p class="text-[#131614] text-sm font-normal leading-normal">{{ star }}</p>
          <div class="flex h-2 flex-1 overflow-hidden rounded-full bg-[#dee3e0]">
            <div class="rounded-full bg-[#131614]" [style.width]="getStarPercent(star) + '%'" ></div>
          </div>
          <p class="text-[#6b8075] text-sm font-normal leading-normal text-right">{{ getStarPercent(star) | number:'1.0-0' }}%</p>
        </ng-container>
      </div>
    </div>
    <div class="flex flex-col gap-8 overflow-x-hidden bg-white p-4">
      <div *ngIf="reviewsLoading" class="text-[#6b8075] text-center py-4">Cargando reseñas...</div>
      <div *ngIf="reviewsError" class="text-[#e57373] text-center py-4">No se pudieron cargar las reseñas.</div>
      <div *ngIf="!reviewsLoading && !reviewsError && reviews.length === 0" class="text-[#6b8075] text-center py-4">Aún no hay reseñas para este lugar.</div>
      <div *ngFor="let review of reviews" class="flex flex-col gap-3 bg-white">
        <div class="flex items-center gap-3">
          <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" style="background-image: url('https://ui-avatars.com/api/?name=' + review.userName + '&background=ceeddd&color=131614');"></div>
          <div class="flex-1">
            <p class="text-[#131614] text-base font-medium leading-normal">{{ review.userName }}</p>
            <p class="text-[#6b8075] text-sm font-normal leading-normal">{{ review.createdAt | date:'short' }}</p>
          </div>
        </div>
        <div class="flex gap-0.5">
          <ng-container *ngFor="let star of [1,2,3,4,5]">
            <div class="text-[#131614]" *ngIf="review.rating >= star">
              <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" viewBox="0 0 256 256">
                <path d="M234.5,114.38l-45.1,39.36,13.51,58.6a16,16,0,0,1-23.84,17.34l-51.11-31-51,31a16,16,0,0,1-23.84-17.34L66.61,153.8,21.5,114.38a16,16,0,0,1,9.11-28.06l59.46-5.15,23.21-55.36a15.95,15.95,0,0,1,29.44,0h0L166,81.17l59.44,5.15a16,16,0,0,1,9.11,28.06Z"/>
              </svg>
            </div>
            <div class="text-[#bfcac4]" *ngIf="review.rating < star">
              <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" viewBox="0 0 256 256">
                <path d="M239.2,97.29a16,16,0,0,0-13.81-11L166,81.17,142.72,25.81h0a15.95,15.95,0,0,0-29.44,0L90.07,81.17,30.61,86.32a16,16,0,0,0-9.11,28.06L66.61,153.8,53.09,212.34a16,16,0,0,0,23.84,17.34l51-31,51.11,31a16,16,0,0,0,23.84-17.34l-13.51-58.6,45.1-39.36A16,16,0,0,0,239.2,97.29Zm-15.22,5-45.1,39.36a16,16,0,0,0-5.08,15.71L187.35,216v0l-51.07-31a15.9,15.9,0,0,0-16.54,0l-51,31h0L82.2,157.4a16,16,0,0,0-5.08-15.71L32,102.35a.37.37,0,0,1,0-.09l59.44-5.14a16,16,0,0,0,13.35-9.75L128,32.08l23.2,55.29a16,16,0,0,0,13.35,9.75L224,102.26S224,102.32,224,102.33Z"/>
              </svg>
            </div>
          </ng-container>
        </div>
        <p class="text-[#131614] text-base font-normal leading-normal">{{ review.comment }}</p>
        <div class="flex gap-9 text-[#6b8075]">
          <button class="flex items-center gap-2" type="button" (click)="$event.preventDefault(); alert('Próximamente: función de Me gusta');">
            <div class="text-inherit">
              <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" viewBox="0 0 256 256">
                <path d="M234,80.12A24,24,0,0,0,216,72H160V56a40,40,0,0,0-40-40,8,8,0,0,0-7.16,4.42L75.06,96H32a16,16,0,0,0-16,16v88a16,16,0,0,0,16,16H204a24,24,0,0,0,23.82-21l12-96A24,24,0,0,0,234,80.12ZM32,112H72v88H32ZM223.94,97l-12,96a8,8,0,0,1-7.94,7H88V105.89l36.71-73.43A24,24,0,0,1,144,56V80a8,8,0,0,0,8,8h64a8,8,0,0,1,7.94,9Z"/>
              </svg>
            </div>
            <p class="text-inherit">Próximamente</p>
          </button>
          <button class="flex items-center gap-2" type="button" (click)="$event.preventDefault(); alert('Próximamente: función de No me gusta');">
            <div class="text-inherit">
              <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" viewBox="0 0 256 256">
                <path d="M239.82,157l-12-96A24,24,0,0,0,204,40H32A16,16,0,0,0,16,56v88a16,16,0,0,0,16,16H75.06l37.78,75.58A8,8,0,0,0,120,240a40,40,0,0,0,40-40V184h56a24,24,0,0,0,23.82-27ZM72,144H32V56H72Zm150,21.29a7.88,7.88,0,0,1-6,2.71H152a8,8,0,0,0-8,8v24a24,24,0,0,1-19.29,23.54L88,150.11V56H204a8,8,0,0,1,7.94,7l12,96A7.87,7.87,0,0,1,222,165.29Z"/>
              </svg>
            </div>
            <p class="text-inherit">Próximamente</p>
          </button>
        </div>
      </div>
      <!-- Formulario para nueva reseña -->
      <div class="px-0 pb-8 pt-2">
        <form [formGroup]="reviewForm" (ngSubmit)="submitReview()" class="bg-[#f5f7f6] rounded-xl p-4 space-y-3">
          <div class="font-bold text-[#131614] pb-1">Agrega tu reseña</div>
          <div class="flex flex-col gap-2">
            <input formControlName="userName" type="text" maxlength="40" placeholder="Tu nombre" class="rounded-lg border border-[#ceeddd] px-3 py-2 text-[#131614] bg-white focus:outline-none focus:ring-2 focus:ring-[#ceeddd]" />
            <textarea formControlName="comment" maxlength="300" placeholder="Escribe tu comentario" rows="2" class="rounded-lg border border-[#ceeddd] px-3 py-2 text-[#131614] bg-white focus:outline-none focus:ring-2 focus:ring-[#ceeddd]"></textarea>
            <div class="flex items-center gap-2">
              <label class="text-[#131614] font-medium">Calificación:</label>
              <select formControlName="rating" class="rounded-lg border border-[#ceeddd] px-2 py-1 bg-white">
                <option *ngFor="let r of [5,4,3,2,1]" [value]="r">{{ r }} ⭐</option>
              </select>
            </div>
          </div>
          <button type="submit" [disabled]="reviewForm.invalid || reviewSubmitting" class="w-full mt-2 rounded-full bg-[#ceeddd] text-[#131614] font-bold py-2 disabled:opacity-60">{{ reviewSubmitting ? 'Enviando...' : 'Enviar reseña' }}</button>
          <div *ngIf="reviewSubmitError" class="text-[#e57373] text-sm pt-2">{{ reviewSubmitError }}</div>
        </form>
      </div>
    </div>
  </div>
  <!-- Menú inferior -->
  <div>
    <div class="flex gap-2 border-t border-[#f1f3f2] bg-white px-4 pb-3 pt-2">
      <a class="just flex flex-1 flex-col items-center justify-end gap-1 text-[#6b8075]" routerLink="/home">
        <div class="text-[#6b8075] flex h-8 items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
            <path d="M218.83,103.77l-80-75.48a1.14,1.14,0,0,1-.11-.11,16,16,0,0,0-21.53,0l-.11.11L37.17,103.77A16,16,0,0,0,32,115.55V208a16,16,0,0,0,16,16H96a16,16,0,0,0,16-16V160h32v48a16,16,0,0,0,16,16h48a16,16,0,0,0,16-16V115.55A16,16,0,0,0,218.83,103.77ZM208,208H160V160a16,16,0,0,0-16-16H112a16,16,0,0,0-16,16v48H48V115.55l.11-.1L128,40l79.9,75.43.11.1Z"/>
          </svg>
        </div>
        <p class="text-[#6b8075] text-xs font-medium leading-normal tracking-[0.015em]">Inicio</p>
      </a>
      <a class="just flex flex-1 flex-col items-center justify-end gap-1 text-[#6b8075]" routerLink="/places">
        <div class="text-[#6b8075] flex h-8 items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
            <path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"></path>
          </svg>
        </div>
        <p class="text-[#6b8075] text-xs font-medium leading-normal tracking-[0.015em]">Explorar</p>
      </a>
      <a class="just flex flex-1 flex-col items-center justify-end gap-1 rounded-full text-[#131614]" routerLink="/favoritos">
        <div class="text-[#131614] flex h-8 items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
            <path d="M240,94c0,70-103.79,126.66-108.21,129a8,8,0,0,1-7.58,0C119.79,220.66,16,164,16,94A62.07,62.07,0,0,1,78,32c20.65,0,38.73,8.88,50,23.89C139.27,40.88,157.35,32,178,32A62.07,62.07,0,0,1,240,94Z"/>
          </svg>
        </div>
        <p class="text-[#131614] text-xs font-medium leading-normal tracking-[0.015em]">Favoritos</p>
      </a>
      <a class="just flex flex-1 flex-col items-center justify-end gap-1 text-[#6b8075]" routerLink="/perfil">
        <div class="text-[#6b8075] flex h-8 items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
            <path d="M230.92,212c-15.23-26.33-38.7-45.21-66.09-54.16a72,72,0,1,0-73.66,0C63.78,166.78,40.31,185.66,25.08,212a8,8,0,1,0,13.85,8c18.84-32.56,52.14-52,89.07-52s70.23,19.44,89.07,52a8,8,0,1,0,13.85-8ZM72,96a56,56,0,1,1,56,56A56.06,56.06,0,0,1,72,96Z"/>
          </svg>
        </div>
        <p class="text-[#6b8075] text-xs font-medium leading-normal tracking-[0.015em]">Perfil</p>
      </a>
    </div>
    <div class="h-5 bg-white"></div>
  </div>
</div>
